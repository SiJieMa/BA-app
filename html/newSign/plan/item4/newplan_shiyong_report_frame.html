<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>门店负责人</title>
		<link rel="stylesheet" type="text/css" href="../../../../css/api.css"/>
		<style>
			html, body {
				background-color: #FFFFFF;
			}
			input,button,select,textarea{
			outline:none;
			box-shadow:none;
			background:none;
			border: none;
			-webkit-tap-highlight-color:rgba(0,0,0,0); 
			}
			textarea{resize:none;-webkit-tap-highlight-color:rgba(0,0,0,0);}
			.pinpailist{ width: 100%; height: auto; float: left; margin-bottom: 60px;}
			.pinpailist .item1{ width: 90%; margin-left: 5%; margin-right: 5%; border-bottom: 1px solid #EFEFEF; height: 50px; float: left;}
			.pinpailist .item1 .ishu{ font-size: 15px; width: auto; height: 50px; line-height: 50px; float: left; color: #666;}
			.pinpailist .item1 button{background-color: #fff; font-size: 14px; color: #666; border: 1px solid #666; margin-left: 5px; border-radius: 5px; float: right; width: 60px; height: 25px; line-height: 25px; margin-top: 12.5px;}
			.pinpailist .item1 .native{background-color: #71C4E4; color: #FFFFFF; border: 1px solid #71C4E4;}
			.pinpailist .item2{ width: 90%; margin-left: 5%; margin-right: 5%; border-bottom: 1px solid #EFEFEF; height: 50px; float: left;}
			.pinpailist .item2 .name{ width: 80px; height: 50px; line-height: 50px; float: left; color: #666;}
			.pinpailist .item2 input{ width: -moz-calc(90% - 80px); width: -webkit-calc(90% - 80px); width: calc(90% - 80px); height: 30px; line-height: 30px; float: left; margin-top: 10px;}
			.pinpailist .item3{ display: none; width: 90%; margin-left: 5%; margin-right: 5%; border-bottom: 1px solid #EFEFEF; height: auto; float: left;}
			.pinpailist .item3 .itempic{ margin: 5px 0; border-radius: 5px; width: 30%; margin-left: 1.5%; margin-right: 1.5%; height: 100px; float: left; background-color: #D9D9D9;}
			.pinpailist .item3 .itempic img{ width: 100%; height: 100%; float: left; border-radius: 5px;}
			.pinpailist .item3 .itempic .add{ width: 40px; height: 40px; float: left; margin-left: -moz-calc(50% - 20px); margin-left: -webkit-calc(50% - 20px); margin-left: calc(50% - 20px); margin-top: 30px;}
			.pinpailist .item3 .information{ width: 98.5%; margin-left: 1.5%; height: 50px; line-height: 50px; float: left; color: #D9D9D9; font-size: 13px;}
			.pinpailist .item3 .information i{ font-style: normal; color: #71C4E4;}
			.pinpailist .item4{ width: 90%; margin-left: 5%; margin-right: 5%; height: auto; float: left;}
			.pinpailist .item4 textarea{ border-radius: 5px; color: #999; padding: 10px 2%; width: 96%; height: 150px; line-height: 30px; font-size: 15px; float: left; margin-top: 10px;  background-color: #D9D9D9;}
			.queding{ width: 100%; height: 60px; position: fixed; bottom: 0; left: 0; background-color: #EEEEEE;}
			.queding button{ width: 90%; height: 50px; float: left; margin-left: 5%; margin-top: 5px; background-color: #71C4E4; color: #FFFFFF; border-radius: 50px;}
		
			.pinpailist .shiyongdetail{ width: 100%; height: auto; float: left; margin: 5px 0; display: none;}
			.pinpailist .shiyongdetail .shoplist{ width: 90%; margin-left: 5%; margin-right: 5%; height: auto; float: left;}
			.pinpailist .shiyongdetail .shoplist ul{ width: 100%; height: 100%; float: left;}
			.pinpailist .shiyongdetail .shoplist ul li{ width: 100%; height: auto; float: left; margin-top: 5px;}
			.pinpailist .shiyongdetail .shoplist ul li .itemgood{ width: 100%; height: 30px; float: left; position: relative;}
			.pinpailist .shiyongdetail .shoplist ul li .itemgood span{overflow: hidden;text-overflow:ellipsis;white-space:nowrap; width: 96%; padding-left: 2%; padding-right: 2%; height: 30px; line-height: 30px; float: left; background-color: #71C4E4; color: #FFFFFF; border-radius: 15px;}
			.pinpailist .shiyongdetail .shoplist ul li .itemgood img{ width: 20px; height: 20px; position: absolute; top: 0; right: 0; padding: 5px;}
			.pinpailist .shiyongdetail .shoplist ul li .additemgood{ width: 100%; height: 30px; float: left; border: 1px solid #999; border-radius: 15px; background-image: url("../../../../image/jiahao999.png"); background-position: center; background-repeat: no-repeat; background-size: 20px 20px;}
		</style>
	</head>
	<body id="body">
		<div class="pinpailist">
			<div class="item1 oneallow">
				<span id="652" class="ishu">试用装是否齐全</span>
				<button value="652" id="652no" class="no">否</button>
				<button value="652" id="652yes" class="yes">是</button>
			</div>
			
			<div id="652goodlist" class="shiyongdetail oneallow">
				<div class="shoplist">
					<ul id="652ul">
						<li id="additemgood652">
							<div value="652" class="additemgood"></div>
						</li>
					</ul>
				</div>
			</div>
			
			<div id="652piclist" class="item3 oneallow">
				<div id="addimg" value="652" class="itempic jiance652">
					<img class="add" src="../../../../image/newSign/newsignadd.png" />
				</div>
				<span class="information">*注：拍摄整体照片,建议拧开拍摄，查看<i onclick="$api.showguize()">拍摄图片标准</i></span>
			</div>
			
			
			<div class="item1 twoallow">
				<span id="653" class="ishu">试用装及嵌槽是否整洁</span>
				<button value="653" id="653no" class="no">否</button>
				<button value="653" id="653yes" class="yes">是</button>
			</div>
			
			<div id="653goodlist" class="shiyongdetail twoallow">
				<div class="shoplist">
					<ul id="653ul">
						<li id="additemgood653">
							<div value="653" class="additemgood"></div>
						</li>
					</ul>
				</div>
			</div>
			
			<div id="653piclist" class="item3  twoallow">
				<div id="addimg" value="653" class="itempic">
					<img class="add" src="../../../../image/newSign/newsignadd.png" />
				</div>
				<span class="information">*注：拍摄整体照片,建议拧开拍摄，查看<i onclick="$api.showguize()">拍摄图片标准</i></span>
			</div>
			
			<div class="item1 threeallow">
				<span id="654" class="ishu">是否有用完/变质/变干</span>
				<button value="654" id="654no" class="no">否</button>
				<button value="654" id="654yes" class="yes">是</button>
			</div>
			
			<div id="654goodlist" class="shiyongdetail threeallow">
				<div class="shoplist">
					<ul id="654ul">
						<!--<li>
							<div class="itemgood">
								<span>名称</span>
								<img src="../../../../image/delimg.png" />
							</div>
						</li>-->
						<li id="additemgood654">
							<div value="654" class="additemgood"></div>
						</li>
					</ul>
				</div>
			</div>
			
			<div id="654piclist" class="item3 threeallow">
				<div id="addimg" value="654" class="itempic jiance654">
					<img class="add" src="../../../../image/newSign/newsignadd.png" />
				</div>
				<span class="information">*注：拍摄整体照片,建议拧开拍摄，查看<i onclick="$api.showguize()">拍摄图片标准</i></span>
			</div>
		</div>
		<div class="queding">
			<button id="savereport">保存</button>
		</div>
	</body>
	<script type="text/javascript" src="../../../../script/api.js"></script>
	<script type="text/javascript" src="../../../../script/newSign/newApi.js"></script>
	<script type="text/javascript" src="../../../../script/newpicdb/localdb.js"></script>
	<script type="text/javascript" src="../../../../script/kunchisale.js"></script>
	<script type="text/javascript" src="../../../../script/newSign/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../../../../script/newSign/newSynthesis.js"></script>
	<script type="text/javascript" src="../../../../script/newSign/newSignCarmerQueHuo.js"></script>
	<script type="text/javascript" src="../../../../script/newSign/localarray.js"></script>
	<script type="text/javascript">
	
		var newpiclist;
		//当前点击的拍照按钮的对象
		var carmerli;
		
		var isupdate = 0;//0不用更新 1用
		
		var oUseTool;
		apiready = function() {
			oUseTool = new PicCK();
			newpiclist = new Arraylist();
			initclick();
			initpic();
			initJianChaProject();
			//开始需要生成规定对应的guid 如果没有已上传的那就新建 否则赋值已上传的
		};
		
		var oneallow = true, twoallow = true, threeallow = true;
		
		function initJianChaProject(){
			/**用来筛选哪些需要显示 哪些需要隐藏*******************************/
			
			var cCustomerFullName = api.pageParam.page.cCustomerFullName;
			var selectbrandname = api.pageParam.brandname;
			/**if(cCustomerFullName == "屈臣氏"){
				if((selectbrandname == 'KISS ME')||(selectbrandname == '凯伊秀')){
					threeallow = false;
				}
			}
			if(cCustomerFullName == "盒马"){
				if(selectbrandname == 'KISS ME'){
					oneallow = false;
					twoallow = false;
				}
			}**/
			
			if(!oneallow){
				$(".oneallow").css("display", "none");
			}
			if(!twoallow){
				$(".twoallow").css("display", "none");
			}
			if(!threeallow){
				$(".threeallow").css("display", "none");
			}
			
			/*******************************************************/
			getonlinedb();
		}
		
		
		var guid1, guid2, guid3;
		
		//开始获取已经保存的数据
		function getonlinedb(){
			api.showProgress({
            });
            var object = new Object();
            object.ireportid = api.pageParam.page.iRorptId;
            object.istoreid = api.pageParam.page.iStoreId;
            object.ibrandid = api.pageParam.ibrandid;
            
			var url = 'ActionApi/T_TrailInfor/Get_TrailInforList';
			$newapi.newpost(url, object, 30000, function(ret, err){
				//console.log(JSON.stringify(ret)+'=='+JSON.stringify(err));
				api.hideProgress();
				guid1 = guidthis();
				guid2 = guidthis();
				guid3 = guidthis();
				if(ret){
					if(ret.length > 0){
						isupdate = 1;
						
						
						var ishasiflag654 = 0; // 0没有  1有
						
						for(var a = 0; a < ret.length; a++){
							//用来控制是否为否
							var goodlisthtml = ret[a].iCheckType+'goodlist';
							var piclisthtml = ret[a].iCheckType+'piclist';
							
							if(ret[a].iCheckType == '652'){
								if((ret[a].PicsList.length == 0)&&(ret[a].isFlag == 0)){
									$("#"+goodlisthtml).css("display", "block");
									$("#"+ret[a].iCheckType+"no").addClass("native");
									$("#"+ret[a].iCheckType+"yes").removeClass("native");
									var additemgoodid = 'additemgood'+ret[a].iCheckType;
						    		var html = '<li guid="'+ret[a].id+'" id="'+ret[a].iCheckType+ret[a].iProductId+'" iProductId="'+ret[a].iProductId+'" value="'+ret[a].cSkus+'"><div class="itemgood">'
											+		'<span>'+ret[a].cSkus+'</span>'
											+		'<img value="'+ret[a].iProductId+'" suoshu="'+ret[a].iCheckType+'" onclick="javascript:deletethisgood(this);" src="../../../../image/delimg.png" />'
											+	'</div></li>';
									if(!isempty(ret[a].iProductId)){
										$("#"+additemgoodid).before(html);
									}		
								}else{
									guid1 = ret[a].id;
									$("#"+piclisthtml).css("display", "block");
									$("#"+ret[a].iCheckType+"no").removeClass("native");
									$("#"+ret[a].iCheckType+"yes").addClass("native");
									for(var b = 0; b < ret[a].PicsList.length; b++){
										var DiyCarmerFinishChu_name_online = ret[a].PicsList[b].cPicPath.split("/")[1];
										var html = '<div online="true" guid="'+ret[a].PicsList[b].iTrainId+'" value="'+ret[a].iCheckType+'" id="ab'+phonenum+'" class="itempic uploadimg" DiyCarmerFinishChu_name="'+DiyCarmerFinishChu_name_online+'">'
												+		'<img onlineid="'+ret[a].PicsList[b].id+'" id="abimg'+phonenum+'" src="'+$api.posturllujie + 'Content/UploadFiles/mobile/' + ret[a].PicsList[b].cPicPath+'" />'
												+	'</div>';
										$("#"+piclisthtml).prepend(html);
										$("#ab"+phonenum).bind('click', phonenum, function(msg){
											var phonenumphonenum = msg.data;
											openpicdetial(phonenumphonenum);
										});
										phonenum++;
									}
									var body = document.getElementById("body");
									var addimgall = $api.domAll(body, '#addimg');
									for(var c = 0; c < addimgall.length; c++){
										if($api.attr(addimgall[c], 'value') == ret[a].iCheckType){
											carmerli = addimgall[c];
										}
									}
									
									GetPicNum(carmerli);
								}
							}else if(ret[a].iCheckType == '653'){
								var isFlag = ret[a].isFlag;
								if(isFlag == 1){
									$("#"+ret[a].iCheckType+"no").removeClass("native");
									$("#"+ret[a].iCheckType+"yes").addClass("native");
								}else{
									$("#"+ret[a].iCheckType+"no").addClass("native");
									$("#"+ret[a].iCheckType+"yes").removeClass("native");
								}
							}else if(ret[a].iCheckType == '654'){
								
								var isFlag = ret[a].isFlag;
								if(isFlag == 1){
									ishasiflag654 = 1;
								}
								
								if((ret[a].PicsList.length == 0)&&(ret[a].cSkus != "")){
									var additemgoodid = 'additemgood'+ret[a].iCheckType;
						    		var html = '<li guid="'+ret[a].id+'" id="'+ret[a].iCheckType+ret[a].iProductId+'" iProductId="'+ret[a].iProductId+'" value="'+ret[a].cSkus+'"><div class="itemgood">'
											+		'<span>'+ret[a].cSkus+'</span>'
											+		'<img value="'+ret[a].iProductId+'" suoshu="'+ret[a].iCheckType+'" onclick="javascript:deletethisgood(this);" src="../../../../image/delimg.png" />'
											+	'</div></li>';
									if(!isempty(ret[a].iProductId)){
										$("#"+additemgoodid).before(html);
									}
								}else{
									guid3 = ret[a].id;
									for(var b = 0; b < ret[a].PicsList.length; b++){
										var DiyCarmerFinishChu_name_online = ret[a].PicsList[b].cPicPath.split("/")[1];
										var html = '<div online="true" guid="'+ret[a].PicsList[b].iTrainId+'" value="'+ret[a].iCheckType+'" id="ab'+phonenum+'" class="itempic uploadimg" DiyCarmerFinishChu_name="'+DiyCarmerFinishChu_name_online+'">'
												+		'<img onlineid="'+ret[a].PicsList[b].id+'" id="abimg'+phonenum+'" src="'+$api.posturllujie + 'Content/UploadFiles/mobile/' + ret[a].PicsList[b].cPicPath+'" />'
												+	'</div>';
										$("#"+piclisthtml).prepend(html);
										$("#ab"+phonenum).bind('click', phonenum, function(msg){
											var phonenumphonenum = msg.data;
											openpicdetial(phonenumphonenum);
										});
										phonenum++;
									}
									var body = document.getElementById("body");
									var addimgall = $api.domAll(body, '#addimg');
									for(var c = 0; c < addimgall.length; c++){
										if($api.attr(addimgall[c], 'value') == ret[a].iCheckType){
											carmerli = addimgall[c];
										}
									}
									GetPicNum(carmerli);
								}
							}
				    	}
				    	if(ishasiflag654 == 1){
							$("#654goodlist").css("display", "block");
							$("#654piclist").css("display", "block");
							$("#654no").removeClass("native");
							$("#654yes").addClass("native");
						}else{
							$("#654no").addClass("native");
							$("#654yes").removeClass("native");
						}
					}
					getshowlocalpic();
				}else{
					api.confirm({
					    title: '获取已保存的数据失败，是否重试？',
					    msg: 'testmsg',
					    buttons: ['确定', '退出']
					}, function(aa, bb) {
					    var index = aa.buttonIndex;
					    if(index == 1){
					    	getonlinedb();
					    }else{
					    	api.closeWin({
                            });
					    }
					});
				}
			});
		}
		
		
		function getshowlocalpic(){
			//查询本地是否有保存得图片
			var addpiclist = [guid1, guid3];
			oUseTool.SELECTguidlist(addpiclist, function(states){
				if(states != ""){
					if(states.data.length > 0){
						for(var b = 0; b < states.data.length; b++){
							var localguid = states.data[b].iTrainId;
							if(guid1 == localguid){
								showPicToHmtl(states.data[b].filename, 'data:image/jpg;base64,'+states.data[b].base64str, states.data[b].guidid, $(".jiance652"))
							}
							if(guid3 == localguid){
								showPicToHmtl(states.data[b].filename, 'data:image/jpg;base64,'+states.data[b].base64str, states.data[b].guidid, $(".jiance654"))
							}
						}
					}
				}
			});
		}
		
		
		/**调用相机进行拍照***************************************************************************/
		//点击拍照进行打卡
		
		var guid;
		
		function startNewPhoto(){
			api.addEventListener({
			    name: 'PaiPicFinish'
			}, function(ret, err) {
			    var PaiPicFinish = ret.value.PaiPicFinish;
			    if(PaiPicFinish == 'ok'){
			    	api.closeWin({
					    name: 'DIYCarmerWin'
					});
					api.closeWin({
					    name: 'showCarmerPicSale'
					});
					api.removeEventListener({
					    name: 'PaiPicFinish'
					});
			    }
			});
			//guid = guidthis();
			openDiyCarmerPaiZhao(api.pageParam.page.cStoreFullName, "试用装拍照", "试用装拍照");
		}
		
		
		function openpicdetial(phonenumphonenum, thisvaluenum){
			api.openFrame({
					name: 'showpic_sale',
					url: 'widget://html/sale/showpic.html',
					rect: {
							x: 0,
							y: 0,
							w: 'auto',
							h: 'auto'
					},
					bounces: false,
					bgColor: 'rgba(0,0,0,0.3)',
					pageParam: {
							url: $("#abimg"+phonenumphonenum).attr('src'),
							id: $("#abimg"+phonenumphonenum).attr('onlineid'),
							divid: "ab"+phonenumphonenum
					}
			});
	
			api.addEventListener({
				name: 'delthis'
			}, function(ret, err) {
				var id456 = ret.value.key2;
				var id123 = ret.value.key1;
				var carmerlithis = document.getElementById(id456);
				var value = $(carmerlithis).attr("value");
				var valuepiclist = value+'piclist';
				
				var onlineis = $(carmerlithis).attr("online");
				
				
				api.toast({
				    msg:'正在删除'
			    });
				if(onlineis == 'true'){
					if(id123.length == 36){
				    	oUseTool.DELpicall(id123, function(states){
							delxml(id456);
							GetPicNum(carmerlithis);
					    	api.toast({
			                    msg:'已删除',
			                    duration: 1000
			                });
						});
						return;
				    }
				
					var url = "ActionApi/T_Pics/DeleteT_Pics";
					$kunchi.kunchipost(url, {
						id : id123
					}, function(aa, bb) {
						if (aa) {
							delxml(id456);
							GetPicNum(carmerlithis);
							/**	var valuepiclisthtml = document.getElementById(valuepiclist);
							var piclist = $api.domAll(valuepiclisthtml, ".uploadimg");
							if(piclist.length >= 1){
								var addpiclist = $api.domAll(valuepiclisthtml, '#addimg');
								for(var a = 0; a < addpiclist.length; a++){
									$(addpiclist[a]).css('display', 'none');
								}
							}else{
								var addpiclist = $api.domAll(valuepiclisthtml, '#addimg');
								for(var a = 0; a < addpiclist.length; a++){
									$(addpiclist[a]).css('display', 'block');
								}
							}**/
					    	api.toast({
			                    msg:'已删除',
			                    duration: 1000
			                });
						} else {
							api.toast({
								msg : '删除失败,请重试.',
								duration : 3000,
								location : 'middle'
							});
						}
					});
				}else{
					if(id123.length == 36){
				    	oUseTool.DELpicall(id123, function(states){
							delxml(id456);
							GetPicNum(carmerlithis);
					    	api.toast({
			                    msg:'已删除',
			                    duration: 1000
			                });
						});
						return;
				    }
				
					console.log('本地');
					delxml(id456);
					GetPicNum(carmerlithis);
					/**var valuepiclisthtml = document.getElementById(valuepiclist);
					var piclist = $api.domAll(valuepiclisthtml, ".uploadimg");
					if(piclist.length >= 1){
						var addpiclist = $api.domAll(valuepiclisthtml, '#addimg');
						for(var a = 0; a < addpiclist.length; a++){
							$(addpiclist[a]).css('display', 'none');
						}
					}else{
						var addpiclist = $api.domAll(valuepiclisthtml, '#addimg');
						for(var a = 0; a < addpiclist.length; a++){
							$(addpiclist[a]).css('display', 'block');
						}
					}**/
			    	api.toast({
	                    msg:'已删除',
	                    duration: 1000
	                });
				}
			});
		}
		//用来查看图片和删除图片使用 只加不减
		var phonenum = 0;
		var cPicClass = '试用装';
		var iStoreId;
		function showPicToHmtl(DiyCarmerFinishChu_name, DiyCarmerFinishChu_url, id, carmerlithat){
			var thisvaluenum = $(carmerlithat).attr('value');
			var html = '<div online="false" guid="'+id+'" value="'+thisvaluenum+'" id="ab'+phonenum+'" class="itempic uploadimg" DiyCarmerFinishChu_name="'+DiyCarmerFinishChu_name+'">'
					+		'<img onlineid="'+id+'" id="abimg'+phonenum+'" src="'+DiyCarmerFinishChu_url+'" />'
					+	'</div>';
			$(carmerlithat).before(html);
			$("#ab"+phonenum).bind('click', phonenum, function(msg){
				var phonenumphonenum = msg.data;
				openpicdetial(phonenumphonenum);
			});
			phonenum++;
			GetPicNum(carmerlithat);
			api.hideProgress();
		}
		//扫描当前容器中的照片数量是多少 如果多余5个 就隐藏加号
		function GetPicNum(carmerlithat){
			var value = $(carmerlithat).attr("value");
			var valuepiclist = value+'piclist';
			var valuepiclisthtml = document.getElementById(valuepiclist);
			var piclist = $api.domAll(valuepiclisthtml, ".uploadimg");
			if(piclist.length >= 5){
				var addpiclist = $api.domAll(valuepiclisthtml, '#addimg');
				for(var a = 0; a < addpiclist.length; a++){
					$(addpiclist[a]).css('display', 'none');
				}
			}else{
				var addpiclist = $api.domAll(valuepiclisthtml, '#addimg');
				for(var a = 0; a < addpiclist.length; a++){
					$(addpiclist[a]).css('display', 'block');
				}
			}
		}
		
		
		/*****************************************************************************/
		
		function initclick(){
			$('.yes').click(function(){
				var value = $(this).attr('value');
				var yesid = value+'yes';
				var noid = value+'no';
				$('#'+yesid).addClass('native');
				$('#'+noid).removeClass('native');
				if(value == '652'){
					var goodlistid = value+"goodlist";
					var piclistid = value+"piclist";
					$("#"+goodlistid).css('display', 'none');
					$("#"+piclistid).css('display', 'block');
				}
				
				if(value == '654'){
					var goodlistid = value+"goodlist";
					var piclistid = value+"piclist";
					$("#"+goodlistid).css('display', 'block');
					$("#"+piclistid).css('display', 'block');
				}
			})
			$('.no').click(function(){
				var value = $(this).attr('value');
				var yesid = value+'yes';
				var noid = value+'no';
				$('#'+yesid).removeClass('native');
				$('#'+noid).addClass('native');
				if(value == '652'){
					var goodlistid = value+"goodlist";
					var piclistid = value+"piclist";
					$("#"+goodlistid).css('display', 'block');
					$("#"+piclistid).css('display', 'none');
				}
				if(value == '654'){
					var goodlistid = value+"goodlist";
					var piclistid = value+"piclist";
					$("#"+goodlistid).css('display', 'none');
					$("#"+piclistid).css('display', 'none');
				}
			})
			$('.additemgood').click(function(){
				var value = $(this).attr("value");
				openselectgoodlist(value);
			});
			$('.itempic').click(function(){
				var value = $(this).attr('value');
				carmerli = this;
				if(value == '652'){
					//1
					guid = guid1;
				}
				if(value == '654'){
					//3
					guid = guid3;
				}
				startNewPhoto();
			});
			$('#savereport').click(function(){
				var no652 =  $("#652no").hasClass('native');				
				var yes652 =  $("#652yes").hasClass('native');				
				var no653 =  $("#653no").hasClass('native');				
				var yes653 =  $("#653yes").hasClass('native');		
				var no654 =  $("#654no").hasClass('native');				
				var yes654 =  $("#654yes").hasClass('native');
				if(!no652&&!yes652&&oneallow){
					alert('请选择试用装是否齐全');
					return;
				}			
				if(!no653&&!yes653&&twoallow){
					alert('请选择试用装及嵌槽是否整洁');
					return;
				}			
				if(!no654&&!yes654&&threeallow){
					alert('请选择是否有用完/变质/变干');
					return;
				}
				
				var jsonbojectarray = new Array();
				if(no652&&oneallow){
					var ul652 = document.getElementById("652ul");
					var ul652html = $api.domAll(ul652, 'li');
					if(ul652html.length <= 1){
						alert("请选择商品");
						return;
					}
					for(var a = 0; a < ul652html.length - 1; a++){
						jsonbojectarray.push(getgoodlist($(ul652html[a]).attr('guid'), $api.getStorage("shiyongshifouqiquan"), 652, 635, 0, $(ul652html[a]).attr('value'), $(ul652html[a]).attr('iProductId')));
					}
				}
				if(no653&&twoallow){
					jsonbojectarray.push(getgoodlist(guid2, $api.getStorage("shiyongshifouzang"), 653, 635, 0, "", ""));
				}
				if(no654&&threeallow){
					jsonbojectarray.push(getgoodlist(guidthis(), $api.getStorage("shiyongshifouyongwan"), 654, 635, 0, "", ""));
				}
				var zhunbeitijiaolist = new Array();
				if(yes652&&oneallow){
					var html652piclist = document.getElementById("652piclist");
					var piclistthis = $api.domAll(html652piclist, '.uploadimg');
					if(piclistthis.length == 0){
						alert('请至少拍一张照片');
						return;
					}else{
						for(var a = 0; a < piclistthis.length; a++){
							var guidhasimg = $api.attr(piclistthis[a], 'guid');
							var imgobject = newpiclist.get(guidhasimg);
							if(!isempty(imgobject)){
								imgobject.iTrainId = guid1;
								zhunbeitijiaolist.push(imgobject);
							}
						}
						jsonbojectarray.push(getgoodlist(guid1, $api.getStorage("shiyongshifouqiquan"), 652, 635, 1, "", ""));
					}
				}
				if(yes653&&twoallow){
					jsonbojectarray.push(getgoodlist(guid2, $api.getStorage("shiyongshifouzang"), 653, 635, 1, "", ""));
				}
				if(yes654&&threeallow){
				
					var ul654 = document.getElementById("654ul");
					var ul654html = $api.domAll(ul654, 'li');
					if(ul654html.length <= 1){
						alert("请选择商品");
						return;
					}
					for(var a = 0; a < ul654html.length - 1; a++){
						jsonbojectarray.push(getgoodlist($(ul654html[a]).attr('guid'), $api.getStorage("shiyongshifouyongwan"), 654, 635, 1, $(ul654html[a]).attr('value'), $(ul654html[a]).attr('iProductId')));
					}
				
					var html654piclist = document.getElementById("654piclist");
					var piclistthis = $api.domAll(html654piclist, '.uploadimg');
					if(piclistthis.length == 0){
						alert('请至少拍一张照片');
						return;
					}else{
						for(var a = 0; a < piclistthis.length; a++){
							var guidhasimg = $api.attr(piclistthis[a], 'guid');
							var imgobject = newpiclist.get(guidhasimg);
							if(!isempty(imgobject)){
								imgobject.iTrainId = guid3;
								imgobject.iStoreId = api.pageParam.page.iStoreId
								zhunbeitijiaolist.push(imgobject);
							}
						}
						jsonbojectarray.push(getgoodlist(guid3, $api.getStorage("shiyongshifouyongwan"), 654, 635, 1, "", ""));
					}
				}
				
				//console.log(JSON.stringify(zhunbeitijiaolist));
				//console.log(JSON.stringify(jsonbojectarray));
				//return;
				api.showProgress();
				$kunchi.kunchipost('ActionApi/T_Pics/T_PicsAdds', zhunbeitijiaolist, function(ret, err) {
					//[{"id":12,"cPicPath":"15143451038591.jpg","cPicClass":"陈列照片","iSize":128378,"dtCreateTime":"2017-12-27T11:55:39.697","cPicType":"PhotoType","iStoreId":"3f59d20c-200e-4967-bc99-d6d8ce797169","iUserId":"b26915ea-b218-428b-a2b3-54395e2a901e","cRoleName":"BA人员","cUserName":"邵芳","iBrandName":"4"},{"id":13,"cPicPath":"15143451038591.jpg","cPicClass":"陈列照片","iSize":128378,"dtCreateTime":"2017-12-27T11:55:39.697","cPicType":"PhotoType","iStoreId":"3f59d20c-200e-4967-bc99-d6d8ce797169","iUserId":"b26915ea-b218-428b-a2b3-54395e2a901e","cRoleName":"BA人员","cUserName":"邵芳","iBrandName":"4"},{"id":14,"cPicPath":"15143451038591.jpg","cPicClass":"陈列照片","iSize":128378,"dtCreateTime":"2017-12-27T11:55:39.697","cPicType":"PhotoType","iStoreId":"3f59d20c-200e-4967-bc99-d6d8ce797169","iUserId":"b26915ea-b218-428b-a2b3-54395e2a901e","cRoleName":"BA人员","cUserName":"邵芳","iBrandName":"4"},{"id":15,"cPicPath":"15143451038591.jpg","cPicClass":"陈列照片","iSize":128378,"dtCreateTime":"2017-12-27T11:55:39.7","cPicType":"PhotoType","iStoreId":"3f59d20c-200e-4967-bc99-d6d8ce797169","iUserId":"b26915ea-b218-428b-a2b3-54395e2a901e","cRoleName":"BA人员","cUserName":"邵芳","iBrandName":"4"}]
					 //console.log(JSON.stringify(ret) + "==" + JSON.stringify(err));
					if (ret) {
						postbaogao(jsonbojectarray);
					} else {
						api.hideProgress();
						api.confirm({
							title : '提示',
							msg : '绑定图片失败,是否重试?',
							buttons : ['确定', '取消']
						}, function(ccc, ddd) {
							var index = ccc.buttonIndex;
							if (index == 1) {
								upload_topicdbonline();
							}
						});
					}
				});
				
			});
		}
		
		
		function postbaogao(jsonbojectarray){
			var url = 'ActionApi/T_TrailInfor/PostT_TrailInfor';
			if(isupdate == 1){
				url = 'ActionApi/T_TrailInfor/PutT_TrailInfor';
			}
			$newapi.newpost(url, jsonbojectarray, 30000, function(ret, err){
				api.hideProgress();
				if(ret){
					openAlert('Alert','widget://html/newSign/dialog/Alert.html');
				}else{
					openAlert('AlertErr','widget://html/newSign/dialog/AlertErr.html');
				}
			});
		}
		
		
		function getgoodlist(id, cCheckItem, iCheckType, iTrailType, isFlag, cSkus, iProductId){
			var object = new Object();
			object.id = id;
			object.cCheckItem = cCheckItem;
			object.iCheckType = iCheckType;
			object.iTrailType = iTrailType;
			object.iReportId = api.pageParam.page.iRorptId;
			object.iProductId = iProductId;
			object.isFlag = isFlag;
			object.cSkus = cSkus;
			object.iStoreId = api.pageParam.page.iStoreId;
			object.iBrandId = api.pageParam.ibrandid;
			return object;
		}
		
		
		function openselectgoodlist(id){
		
			var showid = id;
			var additemgoodid = 'additemgood'+showid;
		
			api.addEventListener({
			    name: 'selectShiYongList'
			}, function(ret, err) {
			    var selectgoodlist = ret.value.key1;
			    if(selectgoodlist.length > 0){
			    
			    	//清理掉已选择的商品 重新上传
			    	var uiid = showid+'ul';
					var uiidhtml = document.getElementById(uiid);
					var allhasselectgood = $api.domAll(uiidhtml, 'li');
					if(allhasselectgood.length > 1){
						for(var a = 0; a < allhasselectgood.length - 1; a++){
							allhasselectgood[a].parentNode.removeChild(allhasselectgood[a]);
						}
					}
			    
			    	for(var a = 0; a < selectgoodlist.length; a++){
			    		var html = '<li guid="'+guidthis()+'" id="'+showid+selectgoodlist[a].iProductId+'" iProductId="'+selectgoodlist[a].iProductId+'" value="'+selectgoodlist[a].cProductName+'"><div class="itemgood">'
								+		'<span>'+selectgoodlist[a].cProductName+'</span>'
								+		'<img value="'+selectgoodlist[a].iProductId+'" suoshu="'+showid+'" onclick="javascript:deletethisgood(this);" src="../../../../image/delimg.png" />'
								+	'</div></li>';
						$("#"+additemgoodid).before(html);
			    	}
			    }
			});
			
			
			var uiid = id+'ul';
			var getinitlistnew = new Array();
			var uiidhtml = document.getElementById(uiid);
			var allhasselectgood = $api.domAll(uiidhtml, 'li');
			if(allhasselectgood.length > 1){
				for(var a = 0; a < allhasselectgood.length - 1; a++){
					var objectgetinitlistnew = new Object();
					var iProductId = $api.attr(allhasselectgood[a], 'iProductId');
					objectgetinitlistnew.iProductId = iProductId;
					getinitlistnew.push(objectgetinitlistnew);
				}
			}
		
			//1是用来缺货
			api.openWin({
                name: 'newplan_shiyong_report_select_win',
                url: 'widget://html/newSign/plan/item4/newplan_shiyong_report_select_win.html',
			    pageParam: {
			        type: '1',
			        title: '试用装',
			        data: api.pageParam.page,
			        brandname : api.pageParam.brandname,
					ibrandid: api.pageParam.ibrandid,
					getinitlist : getinitlistnew
			    }
            });
		}
		
		function deletethisgood(tag){
			var value = $(tag).attr('value');
			var suoshu = $(tag).attr('suoshu');
			var delid = suoshu+ value;
			api.confirm({
			    title: '提示',
			    msg: '是否删除此商品?',
			    buttons: ['确定', '取消']
			}, function(ret, err) {
			    var index = ret.buttonIndex;
			    if(index == 1){
                    setTimeout(function(){
				    	delxml(delid);
				    	api.toast({
		                    msg:'已删除',
		                    duration: 1000
	                    });
                    }, 300);
			    }
			});
		}
		
		/**
		 * 删除某个布局
		 * 将某个div或者li等等在其母布局中清空
		 * 传入参数：该布局在整体布局中的id
		 */
		function delxml(htmlid) {
			var eventdel = document.getElementById(htmlid);
			if (eventdel != null) {
				eventdel.parentNode.removeChild(eventdel);
			}
		}
		
		
		function guidthis() {
		    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
		        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
		        return v.toString(16);
		    });
		}
		function newguid() {
		    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
		        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
		        return v.toString(16);
		    });
		}
		
		
		function openAlert(name, html){
			var framename = name;
			api.openFrame({
					name: name,
					url: html,
					rect: {
							x: 0,
							y: 0,
							w: 'auto',
							h: 'auto'
					},
					bounces: false,
					bgColor: 'rgba(0,0,0,0.3)'
			});
			setTimeout(function(){
				if(framename == "Alert"){
					api.closeWin({
	                });
				}else{
					api.closeFrame({
						name: framename
                    });
				}
			}, 2000);
		}
		
		function isempty(str){
			if((typeof(str) == 'undefined')||(str == null)||(str == "null")||(str == "")||(str == "undefined")){
				return true;
			}else{
				return false;
			}
		}
		
	</script>
</html>