<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>最新的创建货单</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css"/>
		<style>
			body, html{ background-color: #f5f5f5;}
			.liyou{ background-color: #FFFFFF; width: 100%; margin-bottom: 5px; margin-top: 8px; padding-bottom: 10px; height: auto; float: left;}
			.liyou .title{ margin-left: 10px; width: 80px; height: 40px; float: left; line-height: 40px;}
			.liyou .reason{ width: calc(100% - 110px); padding: 5px; background-color: #f2f2f2; height: 80px; line-height: 20px; margin-top: 10px; float: left; outline: none; font-size: 15px;}
			.address{ display: none; background-color: #FFFFFF; margin-top: 10px; width: 100%; width: calc(100% - 4px); padding-top: 10px; padding-bottom: 5px; height: auto; float: left; border: 2px dashed #71C4E4;}
			.address img{ width: 8%; margin-left: 46%; margin-right: 46%; float: left; height: auto;}
			.address span{ width: 100%; height: 30px; float: left; line-height: 30px; text-align: center; color: #71C4E4; font-size: 17px;}
			.addressdiv{ display: none; background-color: #FFFFFF; width: 100%; height: auto; float: left; border-bottom: 2px dashed #71C4E4; padding-bottom: 10px;}
			.addressdiv .addressmsg{ width: 90%; height: auto; float: left;}
			.addressdiv .addressmsg .oneitem{ width: 100%; height: auto; float: left;}
			.addressdiv .addressmsg .oneitem .name{ width: auto; height: 40px; line-height: 40px; margin-left: 10px; float: left;}
			.addressdiv .addressmsg .oneitem .phone{ width: auto; height: 40px; line-height: 40px; margin-right: 10px; float: right;}
			.addressdiv .addressmsg .useraddress{ margin-left: 10px; margin-right: 10px; float: left; line-height: 25px; font-size: 14px;}
			.addressdiv .right{ width: 10%; margin-top: 30px; float: left;}
			.goodlist{ width: 100%; height: auto; float: left; background-color: #71C4E4;}
			.goodlist .title{ width: auto; margin-left: 10px; height: 45px; line-height: 45px; float: left; color: #FFFFFF; font-size: 16px;}
			.goodlist .addgood{ width: 20px; height: 20px; padding: 12.5px 10px; float: right;}
			.gooddetail{ width: 100%; height: auto; float: left;}
			.gooddetail ul{ width: 100%; height: auto; float: left;}
			.gooddetail ul li{ position: relative; padding-top: 5px; padding-bottom: 5px; border-radius: 5px; background-color: #FFFFFF; width: 96%; margin-left: 2%; margin-right: 2%; height: auto; float: left; margin-top: 5px;}
			.gooddetail ul li .downimg{ margin-right: 5px; margin-top: 5px; width: 30px; height: 30px; position: absolute; top: 0; right: 0;}
			.gooddetail ul li .item1{ width: 90%; font-size: 14px; margin-left: 5%; margin-right: 5%; height: auto; float: left; line-height: 25px; }
			.gooddetail ul li .item1 i{ font-style: normal; float: left;}
			.gooddetail ul li .item1 .num16{ font-size: 18px;}
			.gooddetail ul li .item1 .width80{ width: 80px;}
			.gooddetail ul li .item2{ width: 90%; height: auto; float: left; margin-left: 5%; margin-right: 5%;}
			.gooddetail ul li .item2 .leftitem{ width: 120px; height: 25px; float: left; line-height: 25px;}
			.gooddetail ul li .item2 .numinput{ width: 100px; height: 25px; float: left; border-bottom: 1px solid #CCCCCC;}
			.gooddetail ul li .item2 .numinput input{ width: 100px; height: 20px; line-height: 20px; float: left; margin-top: 2.5px; outline: none; text-align: center;}
			.gooddetail ul li .imagelist{ margin-top: 5px; width: 100%; height: auto; float: left;}
			.gooddetail ul li .imagelist .titlepic{ background-color: #f2f2f2; color: #71C4E4; width: 90%; padding-left: 5%; padding-right: 5%; height: 40px; float: left; line-height: 40px;}
			.gooddetail ul li .imagelist img{ width: 50px; height: 50px; float: left; margin: 5px;}
			.gooddetail ul li .item2 .leftitem1{ height: 40px; width: 100px; line-height: 40px; font-size: 14px; float: left;}
			.gooddetail ul li .item2 .selectCK{ width: 100px; height: 40px; line-height: 40px; float: left; font-size: 14px; color: #FF5C01;}

			.mendianinfo{ display: none; border-radius:5px; width: 96%; background-color: #ffffff; padding-left: 2%; padding-right: 2%; height: auto; float: left; border-bottom: 1px solid #f5f5f5;}
			.mendianinfo .shopid{ width: calc(96% - 40px); height: 40px; float: left; line-height: 40px;}
			.mendianinfo .shopid input{ width: 96%; height: 30px; line-height: 30px; margin-top: 5px; float: left; outline: none;}
			.mendianinfo .search{ width: 30px; height: 30px; float: left; padding: 5px;}
			.mendianinfoshow{ display: none; margin-top: 8px; background-color: #ffffff; width: 100%; height: auto; float: left; border-bottom: 5px;}
			.mendianinfoshow .mendianname{ width: 98%; margin-left: 2%; height: 40px; line-height: 40px; float: left; font-size: 15px; color: #666;}
			.mendianinfoshow .selecttype{ width: 98%; margin-left: 2%; height: auto; float: left;}
			.mendianinfoshow .selecttype span{ width: auto; height: 40px; line-height: 40px; float: left; font-size: 15px; color: #666;}
			.mendianinfoshow .selecttype img{ width: 20px; height: 20px; float: right; margin-top: 10px;}


			.GetListPic{ width: 94%; margin-left: 2.5%; height: auto; float: left; margin-bottom: 5px; background-color: #ffffff; border: 2px solid #ffffff;}
			.GetListPic .title{ width: 94%; height: 40px; line-height: 40px; float: left; padding: 0 3%; font-size: 14px;}
			.GetListPic .piclist{ width: 94%; height: auto; float: left;  padding: 5px 3%; background-color: #f5f5f5;}
			.GetListPic .piclist img{ width: 50px; height: 50px; float: left; margin-right: 5px;}

			.handmenu{ display: none; width: 100%; height: 100%; position: fixed; top: 0; left: 0; background-color: rgba(0,0,0,0.5);}
			.handmenu .menuson{ width: 90%; height: auto; float: left; margin-left: 5%; background-color: #f5f5f5;}
			.handmenu .menuson .title{ width: 100%; height: 50px; line-height: 50px; float: left; text-align: center; background-color: #1296DB; color: #FFFFFF; font-size: 20px;}
			.handmenu .menuson .menuitem{ width: 100%; height: 50px; line-height: 50px; float: left; text-align: center; color: #333; background-color: #f5f5f5; border-bottom: 1px solid #eee;}
			.handmenu .menuson .menuquit{ width: 80%; margin-left: 10%; height: 50px; line-height: 50px; margin-top: 10px; margin-bottom: 10px; color: #FFFFFF; background-color: #FF5C01; text-align: center;}
		</style>
	</head>
	<body id="body">

		<div id="handmenu" class="handmenu">
			<div id="menuson" class="menuson">
				<span class="title">菜单</span>
				<span onclick="opensaoyisaotui()" class="menuitem">扫描条码</span>
				<span onclick="openinputdialog()" class="menuitem">输入条码搜索</span>
				<span onclick="quitmenu()" class="menuquit">取消</span>
			</div>
		</div>

		<div class="goodlist">
			<span class="title">填写虚拟库存列表</span>
			<img onclick="addGood()" class="addgood" src="../../image/addfff.png" />
		</div>
		<div class="gooddetail">
			<ul id="goodList">
				<!--<li>
					<span class="item1"><i class="width80">商品名称: </i><i>机房里的撒酒疯离开大树</i></span>
					<span class="item1"><i class="width80">商品编码: </i><i>商品编辑啊房间打扫垃圾分类</i></span>
					<span class="item1"><i class="width80">大仓数量: </i><i class="num16">88</i></span>
					<span class="item1"><i class="width80">可申请数量: </i><i class="num16">999</i></span>
					<div class="item2">
						<span class="leftitem">所需数量:</span>
						<div class="numinput">
							<input />
						</div>
					</div>
					<div class="item2">
						<span class="leftitem">销售金额:</span>
						<div class="numinput">
							<input />
						</div>
					</div>
					<div class="item2">
						<span class="leftitem1">选择所属仓库:</span>
						<div class="selectCK">点击选择</div>
					</div>
					<div class="imagelist">
						<span class="titlepic">点击拍照:</span>
						<img src="../../../../image/addlan.png" />
					</div>
					<img class="downimg"  src="../../../../image/sangedian.png"/>
				</li>-->
			</ul>
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/apiclear.js"></script>
	<script type="text/javascript" src="../../script/log.js"></script>
	<script type="text/javascript" src="../../script/kunchiba.js"></script>
	<script type="text/javascript" src="../../script/kunchisale.js"></script>
	<script type="text/javascript" src="../../script/base64Update.js"></script>
	<script type="text/javascript" src="../../script/db.js"></script>
	<script type="text/javascript" src="../../script/synthesis.js"></script>
	<script type="text/javascript" src="../../script/jquery-1.8.3.min.js"></script>
	<script type="text/javascript">

		var selectshopid;

		apiready = function() {
			api.showProgress({
			    modal: true
			});
			setTimeout("get_shopinfo()", 2000);
			initxml();
		};

		function initxml(){
			var el_handmenu = document.getElementById("handmenu");
			var el_menuson = document.getElementById("menuson");
			var winheight = api.winHeight;
			var marginheight = (winheight - 270) / 2;
			$api.css(el_menuson,'margin-top: '+marginheight+'px;');
			$api.css(el_handmenu,'height: '+winheight+'px;');
		}

		var mendianid = new  Array();
		var mendianname = new  Array();


		function get_shopinfo(){
			mendianid = new  Array();
			mendianname = new  Array();
			if($api.getStorage("roleName") == "BA人员"){
				var body = new Object();
				body.iuserid = $api.getStorage("id");
				$kunchi.kunchipost("ActionApi/T_Store/T_StoreByUserId", body, function(ret,err){
					//console.log(JSON.stringify(ret)+"---"+JSON.stringify(err));
					if(ret){
						if(ret.length == 0){
							api.hideProgress();
							api.alert({
							    title: '提示',
							    msg: '您暂无负责门店，请联系上级或管理员分配门店之后再试。',
							}, function(aaa, bbb) {
								api.closeWin({});
							});
						}else{
							api.hideProgress();
							for(var a = 0; a < ret.length; a++){
								mendianid.push(ret[a].id);
								mendianname.push(ret[a].cStoreFullName);
							}
							showmendianlist();
						}
					}else{
						api.hideProgress();
						api.alert({
						    title: '提示',
						    msg: '当前网络环境较差，无法获取对应门店信息。',
						}, function(aaa, bbb) {
							api.closeWin({
	                        });
						});
					}
				});
			}else{
				var ret = $api.getStorage('SELECTSHOP');
				if(ret.length == 0){
					api.hideProgress();
					api.alert({
							title: '提示',
							msg: '您暂无负责门店，请联系上级或管理员分配门店之后再试。',
					}, function(aaa, bbb) {
						api.closeWin();
					});
				}else{
					for(var a = 0; a < ret.length; a++){
						mendianid.push(ret[a].iStoreId);
						mendianname.push(ret[a].cStoreFullName);
					}
					showmendianlist();
					api.hideProgress();
				}
			}
		}
		var selectshopid = 0;
		var selectshopname = '';
		function showmendianlist(){
			api.actionSheet({
			    title: '选择门店',
			    cancelTitle: '取消',
			    buttons: mendianname
			}, function(ret, err) {
			    var index = ret.buttonIndex;
			    if(index <= mendianname.length){
			    		selectshopid = mendianid[index - 1];
			    		selectshopname = mendianname[index - 1];
			    		getCangkulist();
			    }else{
			    		api.closeWin();
			    }
			});
		}

		var selectiStoreHouseId;
		function getCangkulist(){
			var namelist = new Array();
			var CangKuList = $api.getStorage("CangKuList");
			for(var a = 0; a < CangKuList.length; a++){
				namelist.push(CangKuList[a].cDictName);
			}
			//console.log(JSON.stringify(CangKuList));
			api.actionSheet({
			    title: '选择仓库',
			    cancelTitle: '取消',
			    buttons: namelist
			}, function(ret, err) {
			    var index = ret.buttonIndex;
			    if(index <= namelist.length){
					GETStoreList(CangKuList[index - 1].cDictValue);
					selectiStoreHouseId = CangKuList[index - 1].cDictValue;
			    }
			});
		}


		var shopskulist = [];
		function GETStoreList(nameidlist){
			var istorehouseid = nameidlist;
			api.showProgress({
			    title: '请稍等',
			    text: '准备重要信息',
			    modal: true
			});
			shopskulist = [];
			var body = new Object();
			body.istoreid = selectshopid;
			body.istorehouseid = istorehouseid;
			body.dtTime = $kunchi.todaydate();
			//console.log(JSON.stringify(body));
			$kunchi.kunchipost("ActionApi/T_Report_Sku/T_Report_SkusInventoryByHouse", body, function(ret,err){
				//console.log(JSON.stringify(ret) + "==" + JSON.stringify(err));
//				{
//			        "iInventoryId":20214,
//			        "iStoreId":"1c132ad7-ed44-4108-a5ae-2cb8fd343649",
//			        "iProuductId":1768,
//			        "iSalesCount":0,
//			        "iSalesAmount":0,
//			        "iReceiptNumber":0,
//			        "cProductProductCode":"HG01",
//			        "cStoreFullName":"ZJ1-镇江1",
//			        "cProductFullName":"黛妍蒂肤",
//			        "iProductBrand":42,
//			        "cProductPackage":"",
//			        "iProductUnit":0,
//			        "iCurrentInventory":10000000,
//			        "iStoreHouseId":1,
//			        "iRequestable":0
//			    }
				if(ret){
					api.hideProgress();
					api.toast({
					    msg: '准备完成',
					    duration: 2000,
					    location: 'bottom'
					});
					shopskulist = ret;
				}else{
					api.hideProgress();
					api.confirm({
					    title: '提示',
					    msg: '当前网络环境较差，无法获取对应库存信息。',
					    buttons: ['重试一次', '先退出']
					}, function(ccc, ddd) {
					    var index = ccc.buttonIndex;
					    if(index == 1){
					    	GETStoreList(istorehouseid);
					    }else{
					    	api.closeWin({
                        	});
					    }
					});
				}
			});
		}

		/**
		 *点击确定
		 */
		function tijiaoxunishenhe(){
			var el = document.getElementById("goodList");
			var orderdetaillist = [];
			var indexlist = 0;
			for(var cc = 0; cc < $api.domAll(el, 'li').length; cc++){
				var orderdetailjson = new Object();
				var iproductid = $api.attr($api.domAll(el, 'li')[cc], 'value');
				orderdetailjson.iProuductId = iproductid;
				orderdetailjson.iStoreId = selectshopid;
				orderdetailjson.iStoreHouseId = selectiStoreHouseId;
				var inpuprice = 'price'+iproductid;
				var inputelprice = document.getElementById(inpuprice).value;
				orderdetailjson.iVirtualInventory = inputelprice;

				if(inputelprice.trim().length == 0){
					iscontune = 1;
					alert('请确认商品信息是否填写完整');
					break;
				}

				orderdetaillist[cc] = orderdetailjson;
			}

			if(orderdetaillist == 0){
				alert("您没有填写任何商品信息.");
				return;
			}
			api.showProgress({
			    title: '请稍等',
			    text: '正在提交',
			    modal: true
			});
			//console.log(JSON.stringify(orderdetaillist));
			$kunchi.kunchipost("ActionApi/T_Inventory/SaveTInventory", orderdetaillist, function(ret,err){
				//console.log(JSON.stringify(ret)+"---"+JSON.stringify(err));
				if(ret){
					if(ret.success){
						api.hideProgress();
						api.alert({
						    title: '提示',
						    msg: '保存成功',
						}, function(aaa, bbb) {
							api.closeWin({});
						});
					}else{
						api.hideProgress();
						alert(ret.Msg);
					}
				}else{
					api.hideProgress();
					api.confirm({
					    title: '提示',
					    msg: '当前网络环境较差，无法保存成功。',
					    buttons: ['重试一次', '等等再说']
					}, function(ccc, ddd) {
					    var index = ccc.buttonIndex;
					    if(index == 1){
					    	tijiaoxunishenhe();
					    }
					});

				}
			});
		}


		function addGood(){
			var el_handmenu = document.getElementById("handmenu");
			$api.css(el_handmenu,'display: block;');
		}

		function openinputdialog(){
			quitmenu();
			api.prompt({
				title: '请输入商品条码',
			    buttons: ['确定', '取消']
			}, function(ret, err) {
			    var index = ret.buttonIndex;
			    var text = ret.text;
			    if(index == 1){
			    	if(text.trim().length != 0){
			    		search_goodmas(text);
			    	}else{
			    		alert("请输入商品条码后重试.");
			    	}
			    }
			});
		}

		function quitmenu(){
			var el_handmenu = document.getElementById("handmenu");
			$api.css(el_handmenu,'display: none;');
		}

		function opensaoyisaotui(){
			quitmenu();
			var FNScanner = api.require('FNScanner');
			FNScanner.open({
				sound: 'widget://res/di.wav',
			    autorotation: false
			}, function(ret, err) {
			    if (ret) {
			        if(ret.eventType == "success"){
			        	var content = ret.content;
						search_goodmas(content);
			        }
			    }
			});
		}

		function search_goodmas(content){
			jiazai();
			var body = new Object();
			body.productscode = content;
			$kunchi.kunchipost("ActionApi/T_Product/GET_Products", body, function(ret,err){
				//console.log(JSON.stringify(ret) + "---" + JSON.stringify(err));
				//[{"id":1768,"iProductBrand":42,"cProductCodeNc":"HG01","cProductFullName":"黛妍蒂肤","cProductProductCode":"HG01","cProductBrand":"汉高"}]
				tingzhi();
				if(ret){
					if(ret.length == 0){
						api.alert({
						    title: '提示',
						    msg: '查无此商品',
						}, function(ccc, ddd) {
						});
					}else if(ret.length == 1){
						var el = document.getElementById("goodList");
					    var isarraw = 0;
					    for(var a = 0; a < $api.domAll(el, 'li').length; a++){
					    	var livalue = $api.attr($api.domAll(el, 'li')[a], 'value');
					    	if(ret[0].id == livalue){
					    		isarraw = 1;
					    	}
					    }
					    if(isarraw == 1){
					    	alert("该商品已经添加过了");
					    	return;
					    }


					    var isallowadd = 0;
					    var isallowgoodnum = 0;
					    var cProductProductCode = ret[0].cProductProductCode;
					    for(var c = 0; c < shopskulist.length; c++){
					    	var skucProductProductCode = shopskulist[c].cProductProductCode;
					    	if(cProductProductCode == skucProductProductCode){
					    		isallowadd = 1;
					    		isallowgoodnum = shopskulist[c].iCurrentInventory;
					    	}
					    }

					    if(isallowadd == 0){
					    	alert("无法查询到此商品的实际库存数量,无法添加此商品.");
					    	return;
					    }

						var li = '<li value="'+ret[0].id+'" id="'+ret[0].id+'" name="'+ret[0].cProductFullName+'" cProductCodeNc="'+ret[0].cProductProductCode+'">'
							+		'<span class="item1"><i class="width80">商品名称: </i><i>'+ret[0].cProductFullName+'</i></span>'
							+		'<span class="item1"><i class="width80">商品编码: </i><i>'+ret[0].cProductProductCode+'</i></span>'
							+		'<div class="item2">'
							+			'<span class="leftitem">实际库存数量:</span>'
							+			'<div class="numinput">'
							+				'<input id="num'+ret[0].id+'" value="'+isallowgoodnum+'" readonly="readonly" type="tel"/>'
							+			'</div>'
							+		'</div>'
							+		'<div class="item2">'
							+			'<span class="leftitem">虚拟库存:</span>'
							+			'<div class="numinput">'
							+				'<input id="price'+ret[0].id+'"  oninput="changenum(this)" type="number"/>'
							+			'</div>'
							+		'</div>'
							+		'<img onclick="showPeopleMenu(this)" motherID="'+ret[0].id+'" class="downimg"  src="../../image/sangedian.png"/>'
							+	'</li>';
						$api.prepend(el, li);
					}else{
						var name_show_select = new Array();
						for(var a = 0; a < ret.length; a++){
							name_show_select.push(ret[a].cProductFullName+'('+ret[0].cProductProductCode+')');
						}
						showshoppic(name_show_select, ret);
					}
				}else{
					alert("查无商品记录");
				}
			});
		}

		function changenum(tag){
			$(tag).val($(tag).val().replace(/[^0-9.]/g,''));
		}
		function changejinhuonum(tag){
			$(tag).val($(tag).val().replace(/[^0-9]/g,''));

			var inputnum = $api.val(tag);
			var kucun = $api.attr(tag, "totalnum");
			if(parseInt(inputnum) > parseInt(kucun)){
				alert('您输入的数量大于最大数量,请重新输入.');
				$api.val(tag, "")
				$api.css(tag,'background-color: #ff2222;');
			}else{
				$api.css(tag,'background-color: #ffffff;');
			}
		}

		function showshoppic(arraylist, ret){
			api.actionSheet({
			    title: '选择商品',
			    cancelTitle: '取消',
			    buttons: arraylist
			}, function(ccc, ddd) {
			    var index = ccc.buttonIndex;
			    if(index <= mendianname.length){
			    	var el = document.getElementById("goodList");
				    var isarraw = 0;
				    for(var a = 0; a < $api.domAll(el, 'li').length; a++){
				    	var livalue = $api.attr($api.domAll(el, 'li')[a], 'value');
				    	if(ret[index-1].id == livalue){
				    		isarraw = 1;
				    	}
				    }
				    if(isarraw == 1){
				    	alert("该商品已经添加过了");
				    	return;
				    }

				    var isallowadd = 0;
				    var isallowgoodnum = 0;
				    var cProductProductCode = ret[0].cProductProductCode;
				    for(var c = 0; c < shopskulist.length; c++){
				    	var skucProductProductCode = shopskulist[c].cProductProductCode;
				    	if(cProductProductCode == skucProductProductCode){
				    		isallowadd = 1;
				    		isallowgoodnum = shopskulist[c].iCurrentInventory;
				    	}
				    }

				    if(isallowadd == 0){
				    	alert("无法查询到此商品的实际库存数量,无法添加此商品.");
				    	return;
				    }


					var li = '<li id="'+ret[index-1].id+'" value="'+ret[index-1].id+'" name="'+ret[index-1].cProductFullName+'" cProductCodeNc="'+ret[index-1].cProductProductCode+'">'
						+		'<span class="item1"><i class="width80">商品名称: </i><i>'+ret[index-1].cProductFullName+'</i></span>'
						+		'<span class="item1"><i class="width80">商品编码: </i><i>'+ret[index-1].cProductProductCode+'</i></span>'
						+		'<div class="item2">'
						+			'<span class="leftitem">实际库存数量:</span>'
						+			'<div class="numinput">'
						+				'<input id="num'+ret[index-1].id+'" value="'+isallowgoodnum+'" readonly="readonly" type="tel"/>'
						+			'</div>'
						+		'</div>'
						+		'<div class="item2">'
						+			'<span class="leftitem">虚拟库存:</span>'
						+			'<div class="numinput">'
						+				'<input id="price'+ret[index-1].id+'" oninput="changenum(this)" type="tel"/>'
						+			'</div>'
						+		'</div>'
						+		'<img onclick="showPeopleMenu(this)" motherID="'+ret[index-1].id+'" class="downimg" src="../../../../image/sangedian.png"/>'
						+	'</li>';
					$api.prepend(el, li);
			    }
			});
		}

		function showPeopleMenu(tag){
			api.actionSheet({
			    title: '操作菜单',
			    cancelTitle: '取消',
			    buttons: ['删除']
			}, function(ret, err) {
			    var index = ret.buttonIndex;
			    if(index == 1){
			    	var motherid = $api.attr(tag, 'motherID');
					delxml(motherid);
			    }
			});
		}

	</script>
</html>
