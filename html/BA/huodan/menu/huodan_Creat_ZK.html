<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>最新的创建货单</title>
		<link rel="stylesheet" type="text/css" href="../../../../css/api.css"/>
		<style>
			body, html{ background-color: #f5f5f5;}
			.liyou{ background-color: #FFFFFF; width: 100%; margin-bottom: 5px; margin-top: 8px; padding-bottom: 10px; height: auto; float: left;}
			.liyou .title{ margin-left: 10px; width: 80px; height: 40px; float: left; line-height: 40px;}
			.liyou .reason{ width: calc(100% - 110px); padding: 5px; background-color: #f2f2f2; height: 80px; line-height: 20px; margin-top: 10px; float: left; outline: none; font-size: 15px;}
			.dingdanhao{ background-color: #FFFFFF; display: none; width: 100%; margin-bottom: 5px; margin-top: 8px; height: auto; float: left;}
			.dingdanhao .danhao{ margin-left: 10px; width: 80px; height: 40px; float: left; line-height: 40px;}
			.dingdanhao .inputdanhao{ width: 150px; height: 30px; line-height: 30px; margin-top: 5px; float: left; outline: none; font-size: 15px;}
			.dingdanhao .saodanhao{ width: 25px; height: 25px; float: right; padding: 7.5px; margin-right: 10px;}
			.address{ display: none; background-color: #FFFFFF; margin-top: 10px; width: 100%; width: calc(100% - 4px); padding-top: 10px; padding-bottom: 5px; height: auto; float: left; border: 2px dashed #71C4E4;}
			.address img{ width: 8%; margin-left: 46%; margin-right: 46%; float: left; height: auto;}
			.address span{ width: 100%; height: 30px; float: left; line-height: 30px; text-align: center; color: #71C4E4; font-size: 17px;}
			.addressdiv{ display: none; background-color: #FFFFFF; width: 100%; height: auto; float: left; border-bottom: 2px dashed #71C4E4; padding-bottom: 10px;}
			.addressdiv .addressmsg{ width: 90%; height: auto; float: left;}
			.addressdiv .addressmsg .oneitem{ width: 100%; height: auto; float: left;}
			.addressdiv .addressmsg .oneitem .name{ width: auto; height: 40px; line-height: 40px; margin-left: 10px; float: left;}
			.addressdiv .addressmsg .oneitem .phone{ width: auto; height: 40px; line-height: 40px; margin-right: 10px; float: right;}
			.addressdiv .addressmsg .useraddress{ margin-left: 10px; margin-right: 10px; float: left; line-height: 25px; font-size: 14px;}
			.addressdiv .right{ width: 10%; margin-top: 30px; float: left;}
			.goodlist{ width: 100%; height: auto; float: left; background-color: #71C4E4; margin-top: 10px;}
			.goodlist .title{ width: auto; margin-left: 10px; height: 45px; line-height: 45px; float: left; color: #FFFFFF; font-size: 16px;}
			.goodlist .addgood{ width: 20px; height: 20px; padding: 12.5px 10px; float: right;}
			.gooddetail{ width: 100%; height: auto; float: left;}
			.gooddetail ul{ width: 100%; height: auto; float: left;}
			.gooddetail ul li{ position: relative; padding-top: 5px; padding-bottom: 5px; border-radius: 5px; background-color: #FFFFFF; width: 96%; margin-left: 2%; margin-right: 2%; height: auto; float: left; margin-top: 5px;}
			.gooddetail ul li .downimg{ margin-right: 5px; margin-top: 5px; width: 30px; height: 30px; position: absolute; top: 0; right: 0;}
			.gooddetail ul li .item1{ width: 90%; font-size: 14px; margin-left: 5%; margin-right: 5%; height: auto; float: left; line-height: 25px; }
			.gooddetail ul li .item1 i{ font-style: normal; float: left;}
			.gooddetail ul li .item1 .num16{ font-size: 18px;}
			.gooddetail ul li .item1 .width80{ width: 80px;}
			.gooddetail ul li .item2{ width: 90%; height: auto; float: left; margin-left: 5%; margin-right: 5%;}
			.gooddetail ul li .item2 .leftitem{ width: 80px; height: 25px; float: left; line-height: 25px;}
			.gooddetail ul li .item2 .numinput{ width: 100px; height: 25px; float: left; border-bottom: 1px solid #CCCCCC;}
			.gooddetail ul li .item2 .numinput input{ width: 100px; height: 20px; line-height: 20px; float: left; margin-top: 2.5px; outline: none; text-align: center;}
			.gooddetail ul li .imagelist{ margin-top: 5px; width: 100%; height: auto; float: left;}
			.gooddetail ul li .imagelist .titlepic{ background-color: #f2f2f2; color: #71C4E4; width: 90%; padding-left: 5%; padding-right: 5%; height: 40px; float: left; line-height: 40px;}
			.gooddetail ul li .imagelist img{ width: 50px; height: 50px; float: left; margin: 5px;}

			.mendianinfo{ display: none; border-radius:5px; width: 96%; background-color: #ffffff; padding-left: 2%; padding-right: 2%; height: auto; float: left; border-bottom: 1px solid #f5f5f5;}
			.mendianinfo .shopid{ width: calc(96% - 40px); height: 40px; float: left; line-height: 40px;}
			.mendianinfo .shopid input{ width: 96%; height: 30px; line-height: 30px; margin-top: 5px; float: left; outline: none;}
			.mendianinfo .search{ width: 30px; height: 30px; float: left; padding: 5px;}
			.mendianinfoshow{ display: none; margin-top: 8px; background-color: #ffffff; width: 100%; height: auto; float: left; border-bottom: 5px;}
			.mendianinfoshow .mendianname{ width: 98%; margin-left: 2%; height: 40px; line-height: 40px; float: left; font-size: 15px; color: #666;}
			.mendianinfoshow .selecttype{ width: 98%; margin-left: 2%; height: auto; float: left;}
			.mendianinfoshow .selecttype span{ width: auto; height: 40px; line-height: 40px; float: left; font-size: 15px; color: #666;}
			.mendianinfoshow .selecttype img{ width: 20px; height: 20px; float: right; margin-top: 10px;}
			.GetListPic{ width: 94%; margin-left: 2.5%; height: auto; float: left; margin-bottom: 5px; background-color: #ffffff; border: 2px solid #ffffff;}
			.GetListPic .title{ width: 94%; height: 40px; line-height: 40px; float: left; padding: 0 3%; font-size: 14px;}
			.GetListPic .piclist{ width: 94%; height: auto; float: left;  padding: 5px 3%; background-color: #f5f5f5;}
			.GetListPic .piclist img{ width: 50px; height: 50px; float: left; margin-right: 5px;}
		</style>
	</head>
	<body id="body">
		<div class="liyou">
			<span class="title">转换原因:</span>
			<textarea class="reason" id="tuihuoreason" placeholder="请输入转物料原因"></textarea>
		</div>

		<div class="GetListPic">
			<span class="title">拍照留底，最多可拍摄五张:</span>
			<div id="piclistTUI" value="0" class="piclist">
				<img id="selectPicAdd" onclick="openCarmerPai()" src="../../../../image/addlan.png" />
			</div>
		</div>
		<div class="goodlist">
			<span class="title">商品列表</span>
			<img onclick="addGood()" class="addgood" src="../../../../image/addfff.png" />
		</div>
		<div class="gooddetail">
			<ul id="goodList">
				<!--<li>
					<span class="item1"><i class="width80">商品名称: </i><i>机房里的撒酒疯离开大树</i></span>
					<span class="item1"><i class="width80">商品编码: </i><i>商品编辑啊房间打扫垃圾分类</i></span>
					<span class="item1"><i class="width80">大仓数量: </i><i class="num16">88</i></span>
					<span class="item1"><i class="width80">可申请数量: </i><i class="num16">999</i></span>
					<div class="item2">
						<span class="leftitem">所需数量:</span>
						<div class="numinput">
							<input />
						</div>
					</div>
					<div class="item2">
						<span class="leftitem">销售金额:</span>
						<div class="numinput">
							<input />
						</div>
					</div>
					<div class="imagelist">
						<span class="titlepic">点击拍照:</span>
						<img src="../../../image/addlan.png" />
					</div>
					<img class="downimg"  src="../../../image/sangedian.png"/>
				</li>-->
			</ul>
		</div>
	</body>
	<script type="text/javascript" src="../../../../script/api.js"></script>
	<script type="text/javascript" src="../../../../script/apiclear.js"></script>
	<script type="text/javascript" src="../../../../script/log.js"></script>
	<script type="text/javascript" src="../../../../script/kunchiba.js"></script>
	<script type="text/javascript" src="../../../../script/kunchisale.js"></script>
	<script type="text/javascript" src="../../../../script/base64Update.js"></script>
	<script type="text/javascript" src="../../../../script/db.js"></script>
	<script type="text/javascript" src="../../../../script/synthesis.js"></script>
	<script type="text/javascript" src="../../../../script/jquery-1.8.3.min.js"></script>
	<script type="text/javascript">

		var iStoreHouseId;
		var selectshopid;
		var GoodlistRet;

		apiready = function() {
			initpic();
			setTimeout('close_select_shop_win()', 500);
			selectshopid = api.pageParam.selectistoreid;
			selectshopname =  api.pageParam.selectistorename;
			showcangku(selectshopid);
		};

		function close_select_shop_win(){
			api.closeWin({
		    	name: 'select_shop_win'
            });
		}


		var selectshopid = 0;
		var selectshopname = '';

		var iStoreHouseId;
		function showcangku(selectshopid){
			var zidian = $api.getStorage("CangKuList");
			var namelist = new Array();
			var nameidlist = new Array();
			for(var a = 0; a < zidian.length; a++){
				if(zidian[a].cDictValue != 3){
					namelist.push(zidian[a].cDictName);
					nameidlist.push(zidian[a].cDictValue);
				}
			}
			api.actionSheet({
			    title: '选择仓库',
			    cancelTitle: '取消',
			    buttons: namelist
			}, function(ret, err) {
			    var index = ret.buttonIndex;
			    if(index <= namelist.length){
					iStoreHouseId = nameidlist[index - 1];
					getskulist(selectshopid, nameidlist[index - 1]);
			    }else{
			    	api.closeWin();
			    }
			});
		}


		function getskulist(selectshopid, nameidlist){
			api.showProgress({
			    modal: true
			});
			var body = new Object();
			body.istoreid = selectshopid;
			body.istorehouseid = nameidlist;
			body.dtTime = $kunchi.todaydate();
			$kunchi.kunchipost("ActionApi/T_Report_Sku/T_Report_SkusInventoryByHouse", body, function(ret,err){
				//console.log(JSON.stringify(ret) + "==" + JSON.stringify(err));
				api.hideProgress();
				if(ret){
					if(ret.length == 0){
						api.alert({
						    title: '提示',
						    msg: '您所选择的门店暂无库存商品记录.',
						}, function(aaa, bbb) {
							api.closeWin();
						});
					}else{
						api.toast({
	                        msg:'加载完毕'
                        });
						GoodlistRet = ret;
					}
				}else{
					tingzhi();
					if (err.statusCode == "406") {
						alert(err.msg);
					}else{
						api.alert({
						    title: '提示',
						    msg: '当前网络环境较差，无法获取对应库存信息。',
						}, function(aaa, bbb) {
							api.closeWin({
	                        });
						});
					}
				}
			});
		}

		function addGood(){

			$api.setStorage('GoodlistRet',GoodlistRet);

			var listid = api.pageParam.listid;
			//调货单 调用试用品的接口列表
			openpage("addgoodlist_win", "addgoodlist_frame", "选择商品", "widget://html/BA/huodan/goodlist/good.html", {listid: listid});

			GetEventGoodInfo();
		}

		/**
		 *接收选择的商品参数
		 */
		function GetEventGoodInfo(){
			api.addEventListener({
			    name: 'GetEventGoodInfo'
			}, function(ret, err) {
			    var iProuductId = ret.value.iProuductId;

			    var el = document.getElementById("goodList");
			    var isarraw = 0;
			    for(var a = 0; a < $api.domAll(el, 'li').length; a++){
			    	var livalue = $api.attr($api.domAll(el, 'li')[a], 'value');
			    	if(iProuductId == livalue){
			    		isarraw = 1;
			    	}
			    }
			    if(isarraw == 1){
			    	api.closeWin({
				    	name: 'addgoodlist_win'
	                });
			    	alert("该商品已经添加过了");
			    	return;
			    }

			    var cProductFullName = ret.value.cProductFullName;
			    var cProductProductCode = ret.value.cProductProductCode;
			    var iRequestable = ret.value.iRequestable;
			    InsertGoodHtml(iProuductId, cProductFullName, cProductProductCode, iRequestable);
			    api.closeWin({
			    	name: 'addgoodlist_win'
                });
			});
		}

		function InsertGoodHtml(iProuductId, cProductFullName, cProductProductCode, iRequestable){
			var el = document.getElementById("goodList");
			var html = '';
			var mudate = new Date();
			var thistimedate = mudate.getTime();
			html = '<li id="'+thistimedate+'" value="'+iProuductId+'" name="'+cProductFullName+'" code="'+cProductProductCode+'" totalnum="'+iRequestable+'">'
				+		'<span class="item1"><i class="width80">商品名称: </i><i style="padding-right: 40px; height: auto;">'+cProductFullName+'</i></span>'
				+		'<span class="item1"><i class="width80">商品编码: </i><i>'+cProductProductCode+'</i></span>'
				+		'<span class="item1"><i class="width80">可申请数量: </i><i class="num16">'+iRequestable+'</i></span>'
				+		'<div class="item2">'
				+			'<span class="leftitem">所需数量:</span>'
				+			'<div class="numinput">'
				+				'<input id="input'+iProuductId+'" totalnum="'+iRequestable+'" oninput="changejinhuonum(this)" type="tel" />'
				+			'</div>'
				+		'</div>'
				+		'<div class="item2">'
				+			'<span class="leftitem">商品单价:</span>'
				+			'<div class="numinput">'
				+				'<input id="price'+iProuductId+'" oninput="changenum(this)" type="number"/>'
				+			'</div>'
				+		'</div>'
				+		'<img onclick="showPeopleMenu(this)" motherID="'+thistimedate+'" class="downimg"  src="../../../../image/sangedian.png"/>'
				+	'</li>';
			$api.prepend(el, html);
		}

		function changenum(tag){
			$(tag).val($(tag).val().replace(/[^0-9.]/g,''));
		}
		function changejinhuonum(tag){
			$(tag).val($(tag).val().replace(/[^0-9]/g,''));

			var inputnum = $api.val(tag);
			var kucun = $api.attr(tag, "totalnum");
			if(parseInt(inputnum) > parseInt(kucun)){
				alert('您输入的数量大于最大数量,请重新输入.');
				$api.val(tag, "")
				$api.css(tag,'background-color: #ff2222;');
			}else{
				$api.css(tag,'background-color: #ffffff;');
			}
		}

		function showPeopleMenu(tag){
			api.actionSheet({
			    title: '操作菜单',
			    cancelTitle: '取消',
			    buttons: ['删除']
			}, function(ret, err) {
			    var index = ret.buttonIndex;
			    if(index == 1){
			    	var motherid = $api.attr(tag, 'motherID');
					delxml(motherid);
			    }
			});
		}

		function TiJiaoShenHe(){
			if(api.pageParam.isSH == 0){
				upload_baogao([]);
				return;
			}
		 	jiazai();
			var body = new Object();
			body.userid = $api.getStorage('id');
			body.ordertype = api.pageParam.listid;
			$kunchi.kunchipost("ActionApi/T_Orders/GetUserAuthor", body, function(ret,err){
				//console.log(JSON.stringify(ret) + "---" + JSON.stringify(err));
				tingzhi();
				if(ret){
					upload_baogao(ret);
				}else{
					api.alert({
					    title: '提示',
					    msg: err.msg,
					}, function(abcd, efgh) {
					});
				}
			});
		}
		/**
		 *点击确定
		 */
		function upload_baogao(aaa){
			var el = document.getElementById("goodList");
			var json = new Object();
			json.cOrderCode = null;
			json.iOrderType = api.pageParam.listid;
			json.iPreparedId = $api.getStorage("id");
			json.dtPrepTime = $kunchi.todaytime();
			/**
			 *用来判断是否还可以继续
			 */
			var iscontune = 0;

			if(aaa.length == 2){
				for(var a = 0; a < aaa.length; a++){
					if(aaa[a].RoleName == '业务主管'){
						json.iDirectorId = aaa[a].UserID;
					}else{
						json.iAuthorizeId = aaa[a].UserID;
					}
				}
			}
			if(aaa.length == 1){
				json.iDirectorId = aaa[0].UserID;
				json.iAuthorizeId = aaa[0].UserID;
			}
			if(aaa.length == 0){
				json.iDirectorId = null;
				json.iAuthorizeId = null;
			}

			if(iscontune == 0){
				json.iAuthoState = $api.getStorage('baiAuthoState');
				json.iOrderState = $api.getStorage('baiOrderState');

				json.iStoreId = selectshopid;
				json.iStoreHouseId = iStoreHouseId;
				json.cRemark = document.getElementById("tuihuoreason").value;//备注
				var orderdetaillist = [];
				var indexlist = 0;


				for(var cc = 0; cc < $api.domAll(el, 'li').length; cc++){
					var orderdetailjson = new Object();
					var iproductid = $api.attr($api.domAll(el, 'li')[cc], 'value');
					orderdetailjson.iProId = iproductid;

					var inputel = 'input'+iproductid;
					var inputelnum = document.getElementById(inputel).value;

					var inpuprice = 'price'+iproductid;
					var inputelprice = document.getElementById(inpuprice).value;

					orderdetailjson.iCount = inputelnum;
					orderdetailjson.iSignCount = inputelnum;
					orderdetailjson.iPrice = inputelprice;
					orderdetailjson.iMoney = (parseInt(inputelnum) * parseFloat(inputelprice)).toFixed(2);

					if((inputelnum.trim().length == 0)||(inputelprice.trim().length == 0)){
						iscontune = 1;
						alert('请确认商品信息是否填写完整');
						break;
					}
					if(inputelnum == 0){
						iscontune = 1;
						alert('商品数量必须大于0');
						break;
					}

					orderdetailjson.goodname = $api.attr($api.domAll(el, 'li')[cc], 'name');
					orderdetailjson.goodcode = $api.attr($api.domAll(el, 'li')[cc], 'code');
					orderdetailjson.totalnum = $api.attr($api.domAll(el, 'li')[cc], 'totalnum');

					orderdetailjson.iStoreHouseId = iStoreHouseId;

					orderdetaillist[cc] = orderdetailjson;
				}
				json.T_OrderDetail = orderdetaillist;


				/**
				 *将退货的图片列表加进去
				 */
				var TJjson = new Object();
				TJjson._Order = json;
				var selectPicListID_EL = document.getElementById("piclistTUI");
				var picNumber = $api.attr(selectPicListID_EL, 'value');

				var TJpiclist = new Array();
				if(picNumber > 0){
					for(var pa = 0; pa < picNumber; pa++){
						var TJpicDOM = $api.domAll(selectPicListID_EL, 'img');
						var TJpicObj = new Object();
						TJpicObj.cPicClass = '商品转物料拍照';
						TJpicObj.cPicPath = $kunchi.gettodaydate() + '/' + $api.attr(TJpicDOM[pa], 'name');
						TJpicObj.cPicType = "PhotoType";
						TJpicObj.cRoleName = $api.getStorage("roleName");
						TJpicObj.cUserName = $api.getStorage("realName");
						TJpicObj.iStoreId = selectshopid;
						TJpicObj.iSize = 0;
						TJpicObj.iUserId = $api.getStorage("id");
						TJpicObj.dtUploadTime = $kunchi.todaytime();
						TJpiclist.push(TJpicObj);
					}
				}
				TJjson._Pic = TJpiclist;

				if(iscontune == 0){
					if(orderdetaillist == 0){
						alert("您没有填写任何商品信息.");
						return;
					}
					$api.setStorage("tijiaohuodan",TJjson);
					openpage('huodan_Creat_ZK_Show_win', 'huodan_Creat_ZK_Show_frame', '确认订单', "widget://html/BA/huodan/menu/huodan_Creat_ZK_Show.html", {listid: api.pageParam.listid});
				}
			}
		}


		function openCarmerPai(){
			var selectPicListID_EL = document.getElementById("piclistTUI");
			var picNumber = $api.attr(selectPicListID_EL, 'value');
			if(picNumber >= 5){
				api.alert({
				    title: '错误提示',
				    msg: '每条商品最多只能拍五张图片',
				}, function(aaa, ccc) {
				});
				return;
			}

			api.addEventListener({
			    name: 'PaiPicFinish'
			}, function(ret, err) {
			    var PaiPicFinish = ret.value.PaiPicFinish;
			    if(PaiPicFinish == 'ok'){
			    	api.closeWin({
					    name: 'DIYCarmerWin'
					});
					api.closeWin({
					    name: 'showCarmerPicSale'
					});
			    	upload_toonline_diycarmer();
			    }
			});
			openDiyCarmerPaiZhao(selectshopname, '商品转物料拍照', '商品转物料拍照');
		}

		function upload_toonline_diycarmer(){
			var myDate = new Date();
			var selectPicAdd = document.getElementById("selectPicAdd");
			var elimg = '<img onclick="showpic(this)" id="'+myDate.getTime()+'" name="'+DiyCarmerFinishChu_name+'" src="'+'data:image/jpg;base64,' + DiyCarmerFinishChu_url+'" />';
			$api.before(selectPicAdd, elimg);
			var selectPicListID_EL = document.getElementById("piclistTUI");
			var picNumber = $api.attr(selectPicListID_EL, 'value');
			picNumber = parseInt(picNumber) + 1;
			$api.attr(selectPicListID_EL, 'value', picNumber);
			if(picNumber >= 5){
				$api.css(selectPicAdd,'display: none;');
			}
		}

		function showpic(tag) {
			api.openFrame({
			    name: 'showpic',
			    url: 'widget://html/sale/showpic.html',
			    rect: {
			        x: 0,
			        y: 0,
			        w: 'auto',
			        h: 'auto'
			    },
			    bounces: false,
			    bgColor: 'rgba(0,0,0,0.3)',
			    pageParam: {
			        url: $api.attr(tag, 'src'),
			        id: $api.attr(tag, 'id'),
			        divid: ""
			    }
			});

			api.addEventListener({
			    name: 'delthis'
			}, function(ret, err) {
				var id = ret.value.key1;
				var showpicdividID = document.getElementById("piclistTUI");
				var picNumber = $api.attr(showpicdividID, 'value');
				picNumber = parseInt(picNumber) - 1;
				$api.attr(showpicdividID, 'value', picNumber);
				delxml(id);
				api.removeEventListener({
				    name: 'delthis'
				});
				var selectPicAdd = document.getElementById("selectPicAdd");
				$api.css(selectPicAdd,'display: block;');
			});
		}


	</script>
</html>
